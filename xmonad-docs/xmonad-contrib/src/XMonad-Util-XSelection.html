<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>XMonad/Util/XSelection.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-2"></a><span class='hs-comment'>{- |
<a name="line-3"></a>Module      :  XMonad.Util.XSelection
<a name="line-4"></a>Copyright   :  (C) 2007 Andrea Rossato, Matthew Sackman
<a name="line-5"></a>License     :  BSD3
<a name="line-6"></a>
<a name="line-7"></a>Maintainer  : Gwern Branwen &lt;gwern0@gmail.com&gt;
<a name="line-8"></a>Stability   :  unstable
<a name="line-9"></a>Portability :  unportable
<a name="line-10"></a>
<a name="line-11"></a>A module for accessing and manipulating X Window's mouse selection (the buffer used in copy and pasting).
<a name="line-12"></a>'getSelection' is an adaptation of Hxsel.hs and Hxput.hs from the XMonad-utils, available:
<a name="line-13"></a>
<a name="line-14"></a>&gt; $ darcs get &lt;<a href="http://gorgias.mine.nu/repos/xmonad-utils">http://gorgias.mine.nu/repos/xmonad-utils</a>&gt;
<a name="line-15"></a>-}</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>XMonad</span><span class='hs-varop'>.</span><span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>XSelection</span> <span class='hs-layout'>(</span>  <span class='hs-comment'>-- * Usage</span>
<a name="line-18"></a>                                 <span class='hs-comment'>-- $usage</span>
<a name="line-19"></a>                                 <span class='hs-varid'>getSelection</span><span class='hs-layout'>,</span>
<a name="line-20"></a>                                 <span class='hs-varid'>promptSelection</span><span class='hs-layout'>,</span>
<a name="line-21"></a>                                 <span class='hs-varid'>safePromptSelection</span><span class='hs-layout'>,</span>
<a name="line-22"></a>                                 <span class='hs-varid'>transformPromptSelection</span><span class='hs-layout'>,</span>
<a name="line-23"></a>                                 <span class='hs-varid'>transformSafePromptSelection</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span><span class='hs-varop'>.</span><span class='hs-conid'>Extensible</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>E</span> <span class='hs-layout'>(</span><span class='hs-varid'>catch</span><span class='hs-layout'>,</span><span class='hs-conid'>SomeException</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftM</span><span class='hs-layout'>,</span> <span class='hs-varid'>join</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>XMonad</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>XMonad</span><span class='hs-varop'>.</span><span class='hs-conid'>Util</span><span class='hs-varop'>.</span><span class='hs-conid'>Run</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeSpawn</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeSpawn</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Codec</span><span class='hs-varop'>.</span><span class='hs-conid'>Binary</span><span class='hs-varop'>.</span><span class='hs-conid'>UTF8</span><span class='hs-varop'>.</span><span class='hs-conid'>String</span> <span class='hs-layout'>(</span><span class='hs-varid'>decode</span><span class='hs-layout'>)</span>
<a name="line-32"></a>
<a name="line-33"></a><span class='hs-comment'>{- $usage
<a name="line-34"></a>   Add @import XMonad.Util.XSelection@ to the top of Config.hs
<a name="line-35"></a>   Then make use of getSelection or promptSelection as needed; if
<a name="line-36"></a>   one wanted to run Firefox with the selection as an argument (perhaps
<a name="line-37"></a>   the selection string is an URL you just highlighted), then one could add
<a name="line-38"></a>   to the xmonad.hs a line like thus:
<a name="line-39"></a>
<a name="line-40"></a>   &gt; , ((modm .|. shiftMask, xK_b), promptSelection "firefox")
<a name="line-41"></a>
<a name="line-42"></a>   Future improvements for XSelection:
<a name="line-43"></a>
<a name="line-44"></a>   * More elaborate functionality: Emacs' registers are nice; if you
<a name="line-45"></a>      don't know what they are, see &lt;<a href="http://www.gnu.org/software/emacs/manual/html_node/emacs/Registers.html#Registers">http://www.gnu.org/software/emacs/manual/html_node/emacs/Registers.html#Registers</a>&gt; -}</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="getSelection"></a><span class='hs-comment'>-- | Returns a String corresponding to the current mouse selection in X;</span>
<a name="line-48"></a><span class='hs-comment'>--   if there is none, an empty string is returned.</span>
<a name="line-49"></a><span class='hs-definition'>getSelection</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>String</span>
<a name="line-50"></a><span class='hs-definition'>getSelection</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-51"></a>  <span class='hs-varid'>dpy</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openDisplay</span> <span class='hs-str'>""</span>
<a name="line-52"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>dflt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultScreen</span> <span class='hs-varid'>dpy</span>
<a name="line-53"></a>  <span class='hs-varid'>rootw</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rootWindow</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>dflt</span>
<a name="line-54"></a>  <span class='hs-varid'>win</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>createSimpleWindow</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>rootw</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span>
<a name="line-55"></a>  <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>internAtom</span> <span class='hs-varid'>dpy</span> <span class='hs-str'>"PRIMARY"</span> <span class='hs-conid'>True</span>
<a name="line-56"></a>  <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-varid'>catch</span>
<a name="line-57"></a>               <span class='hs-layout'>(</span><span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-varid'>catch</span>
<a name="line-58"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>internAtom</span> <span class='hs-varid'>dpy</span> <span class='hs-str'>"UTF8_STRING"</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-59"></a>                     <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>SomeException</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>internAtom</span> <span class='hs-varid'>dpy</span> <span class='hs-str'>"COMPOUND_TEXT"</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-60"></a>             <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>E</span><span class='hs-varop'>.</span><span class='hs-conid'>SomeException</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>internAtom</span> <span class='hs-varid'>dpy</span> <span class='hs-str'>"sTring"</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-61"></a>  <span class='hs-varid'>clp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>internAtom</span> <span class='hs-varid'>dpy</span> <span class='hs-str'>"BLITZ_SEL_STRING"</span> <span class='hs-conid'>False</span>
<a name="line-62"></a>  <span class='hs-varid'>xConvertSelection</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>clp</span> <span class='hs-varid'>win</span> <span class='hs-varid'>currentTime</span>
<a name="line-63"></a>  <span class='hs-varid'>allocaXEvent</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-64"></a>    <span class='hs-varid'>nextEvent</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>e</span>
<a name="line-65"></a>    <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEvent</span> <span class='hs-varid'>e</span>
<a name="line-66"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>ev_event_type</span> <span class='hs-varid'>ev</span> <span class='hs-varop'>==</span> <span class='hs-varid'>selectionNotify</span>
<a name="line-67"></a>       <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWindowProperty8</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>clp</span> <span class='hs-varid'>win</span>
<a name="line-68"></a>               <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>decode</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>res</span>
<a name="line-69"></a>       <span class='hs-keyword'>else</span> <span class='hs-varid'>destroyWindow</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>win</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-str'>""</span>
<a name="line-70"></a>
<a name="line-71"></a><a name="promptSelection"></a><span class='hs-comment'>{- | A wrapper around 'getSelection'. Makes it convenient to run a program with the current selection as an argument.
<a name="line-72"></a>  This is convenient for handling URLs, in particular. For example, in your Config.hs you could bind a key to
<a name="line-73"></a>         @promptSelection \"firefox\"@;
<a name="line-74"></a>  this would allow you to highlight a URL string and then immediately open it up in Firefox.
<a name="line-75"></a>
<a name="line-76"></a>  'promptSelection' passes strings through the system shell, \/bin\/sh; if you do not wish your selected text
<a name="line-77"></a>  to be interpreted or mangled by the shell, use 'safePromptSelection'. safePromptSelection will bypass the
<a name="line-78"></a>  shell using 'safeSpawn' from "XMonad.Util.Run"; see its documentation for more
<a name="line-79"></a>  details on the advantages and disadvantages of using safeSpawn. -}</span>
<a name="line-80"></a><span class='hs-definition'>promptSelection</span><span class='hs-layout'>,</span> <span class='hs-varid'>safePromptSelection</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafePromptSelection</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>X</span> <span class='hs-conid'>()</span>
<a name="line-81"></a><span class='hs-definition'>promptSelection</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePromptSelection</span>
<a name="line-82"></a><a name="safePromptSelection"></a><span class='hs-definition'>safePromptSelection</span> <span class='hs-varid'>app</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>join</span> <span class='hs-varop'>$</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeSpawn</span> <span class='hs-varid'>app</span> <span class='hs-varop'>.</span> <span class='hs-varid'>return</span><span class='hs-layout'>)</span> <span class='hs-varid'>getSelection</span>
<a name="line-83"></a><a name="unsafePromptSelection"></a><span class='hs-definition'>unsafePromptSelection</span> <span class='hs-varid'>app</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>join</span> <span class='hs-varop'>$</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>unsafeSpawn</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>app</span> <span class='hs-varop'>++</span> <span class='hs-str'>" "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>getSelection</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="transformPromptSelection"></a><span class='hs-comment'>{- | A wrapper around 'promptSelection' and its safe variant. They take two parameters, the
<a name="line-86"></a>     first is a function that transforms strings, and the second is the application to run.
<a name="line-87"></a>     The transformer essentially transforms the selection in X.
<a name="line-88"></a>     One example is to wrap code, such as a command line action copied out of the browser
<a name="line-89"></a>     to be run as @"sudo" ++ cmd@ or @"su - -c \""++ cmd ++"\""@. -}</span>
<a name="line-90"></a><span class='hs-definition'>transformPromptSelection</span><span class='hs-layout'>,</span> <span class='hs-varid'>transformSafePromptSelection</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>X</span> <span class='hs-conid'>()</span>
<a name="line-91"></a><span class='hs-definition'>transformPromptSelection</span> <span class='hs-varid'>f</span> <span class='hs-varid'>app</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>join</span> <span class='hs-varop'>$</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeSpawn</span> <span class='hs-varid'>app</span> <span class='hs-varop'>.</span> <span class='hs-varid'>return</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>getSelection</span><span class='hs-layout'>)</span>
<a name="line-92"></a><a name="transformSafePromptSelection"></a><span class='hs-definition'>transformSafePromptSelection</span> <span class='hs-varid'>f</span> <span class='hs-varid'>app</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>join</span> <span class='hs-varop'>$</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>unsafeSpawn</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>app</span> <span class='hs-varop'>++</span> <span class='hs-str'>" "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>getSelection</span><span class='hs-layout'>)</span>
</pre></body>
</html>
