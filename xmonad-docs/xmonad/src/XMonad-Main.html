<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>dist/build/XMonad/Main.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LINE 1 "XMonad/Main.hsc" #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE MultiParamTypeClasses, FlexibleContexts, ForeignFunctionInterface #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LINE 2 "XMonad/Main.hsc" #-}</span>
<a name="line-4"></a><span class='hs-comment'>----------------------------------------------------------------------------</span>
<a name="line-5"></a><span class='hs-comment'>-- |</span>
<a name="line-6"></a><span class='hs-comment'>-- Module      :  XMonad.Main</span>
<a name="line-7"></a><span class='hs-comment'>-- Copyright   :  (c) Spencer Janssen 2007</span>
<a name="line-8"></a><span class='hs-comment'>-- License     :  BSD3-style (see LICENSE)</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>-- Maintainer  :  spencerjanssen@gmail.com</span>
<a name="line-11"></a><span class='hs-comment'>-- Stability   :  unstable</span>
<a name="line-12"></a><span class='hs-comment'>-- Portability :  not portable, uses mtl, X11, posix</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-comment'>-- xmonad, a minimalist, tiling window manager for X11</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>XMonad</span><span class='hs-varop'>.</span><span class='hs-conid'>Main</span> <span class='hs-layout'>(</span><span class='hs-varid'>xmonad</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span> <span class='hs-layout'>(</span><span class='hs-varid'>second</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bits</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>\\</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Function</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>M</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Reader</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>State</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span><span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Monoid</span> <span class='hs-layout'>(</span><span class='hs-varid'>getAll</span><span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>C</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>Ptr</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Environment</span> <span class='hs-layout'>(</span><span class='hs-varid'>getArgs</span><span class='hs-layout'>)</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Graphics</span><span class='hs-varop'>.</span><span class='hs-conid'>X11</span><span class='hs-varop'>.</span><span class='hs-conid'>Xlib</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>refreshKeyboardMapping</span><span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Graphics</span><span class='hs-varop'>.</span><span class='hs-conid'>X11</span><span class='hs-varop'>.</span><span class='hs-conid'>Xlib</span><span class='hs-varop'>.</span><span class='hs-conid'>Extras</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>XMonad</span><span class='hs-varop'>.</span><span class='hs-conid'>Core</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>XMonad</span><span class='hs-varop'>.</span><span class='hs-conid'>Config</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Default</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>XMonad</span><span class='hs-varop'>.</span><span class='hs-conid'>StackSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>new</span><span class='hs-layout'>,</span> <span class='hs-varid'>floating</span><span class='hs-layout'>,</span> <span class='hs-varid'>member</span><span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>XMonad</span><span class='hs-varop'>.</span><span class='hs-conid'>StackSet</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>W</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>XMonad</span><span class='hs-varop'>.</span><span class='hs-conid'>Operations</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-48"></a><span class='hs-comment'>-- Locale support</span>
<a name="line-49"></a>
<a name="line-50"></a>
<a name="line-51"></a><span class='hs-comment'>{-# LINE 49 "XMonad/Main.hsc" #-}</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"locale.h setlocale"</span>
<a name="line-54"></a>    <span class='hs-varid'>c_setlocale</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CInt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>CChar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>CChar</span><span class='hs-layout'>)</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-comment'>------------------------------------------------------------------------</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="xmonad"></a><span class='hs-comment'>-- |</span>
<a name="line-59"></a><span class='hs-comment'>-- The main entry point</span>
<a name="line-60"></a><span class='hs-comment'>--</span>
<a name="line-61"></a><span class='hs-definition'>xmonad</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LayoutClass</span> <span class='hs-varid'>l</span> <span class='hs-conid'>Window</span><span class='hs-layout'>,</span> <span class='hs-conid'>Read</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span> <span class='hs-conid'>Window</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>XConfig</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-62"></a><span class='hs-definition'>xmonad</span> <span class='hs-varid'>initxmc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-63"></a>    <span class='hs-comment'>-- setup locale information from environment</span>
<a name="line-64"></a>    <span class='hs-varid'>withCString</span> <span class='hs-str'>""</span> <span class='hs-varop'>$</span> <span class='hs-varid'>c_setlocale</span> <span class='hs-layout'>(</span><span class='hs-num'>6</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-comment'>{-# LINE 62 "XMonad/Main.hsc" #-}</span>
<a name="line-66"></a>    <span class='hs-comment'>-- ignore SIGPIPE and SIGCHLD</span>
<a name="line-67"></a>    <span class='hs-varid'>installSignalHandlers</span>
<a name="line-68"></a>    <span class='hs-comment'>-- First, wrap the layout in an existential, to keep things pretty:</span>
<a name="line-69"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>xmc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initxmc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>layoutHook</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Layout</span> <span class='hs-varop'>$</span> <span class='hs-varid'>layoutHook</span> <span class='hs-varid'>initxmc</span> <span class='hs-layout'>}</span>
<a name="line-70"></a>    <span class='hs-varid'>dpy</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openDisplay</span> <span class='hs-str'>""</span>
<a name="line-71"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultScreen</span> <span class='hs-varid'>dpy</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-varid'>rootw</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rootWindow</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>dflt</span>
<a name="line-74"></a>
<a name="line-75"></a>    <span class='hs-varid'>args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getArgs</span>
<a name="line-76"></a>
<a name="line-77"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-str'>"--replace"</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>replace</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>dflt</span> <span class='hs-varid'>rootw</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-comment'>-- If another WM is running, a BadAccess error will be returned.  The</span>
<a name="line-80"></a>    <span class='hs-comment'>-- default error handler will write the exception to stderr and exit with</span>
<a name="line-81"></a>    <span class='hs-comment'>-- an error.</span>
<a name="line-82"></a>    <span class='hs-varid'>selectInput</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>rootw</span> <span class='hs-varop'>$</span>  <span class='hs-varid'>substructureRedirectMask</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>substructureNotifyMask</span>
<a name="line-83"></a>                         <span class='hs-varop'>.|.</span> <span class='hs-varid'>enterWindowMask</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>leaveWindowMask</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>structureNotifyMask</span>
<a name="line-84"></a>                         <span class='hs-varop'>.|.</span> <span class='hs-varid'>buttonPressMask</span>
<a name="line-85"></a>    <span class='hs-varid'>sync</span> <span class='hs-varid'>dpy</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- sync to ensure all outstanding errors are delivered</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-comment'>-- turn off the default handler in favor of one that ignores all errors</span>
<a name="line-88"></a>    <span class='hs-comment'>-- (ugly, I know)</span>
<a name="line-89"></a>    <span class='hs-varid'>xSetErrorHandler</span> <span class='hs-comment'>-- in C, I'm too lazy to write the binding: dons</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-varid'>xinesc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCleanedScreenInfo</span> <span class='hs-varid'>dpy</span>
<a name="line-92"></a>    <span class='hs-varid'>nbc</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>v</span>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initColor</span> <span class='hs-varid'>dpy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>normalBorderColor</span>  <span class='hs-varid'>xmc</span>
<a name="line-93"></a>                 <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>nbc_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initColor</span> <span class='hs-varid'>dpy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>normalBorderColor</span> <span class='hs-conid'>Default</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultConfig</span>
<a name="line-94"></a>                 <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>nbc_</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-95"></a>
<a name="line-96"></a>    <span class='hs-varid'>fbc</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initColor</span> <span class='hs-varid'>dpy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>focusedBorderColor</span> <span class='hs-varid'>xmc</span>
<a name="line-97"></a>                 <span class='hs-keyglyph'>~</span><span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fbc_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initColor</span> <span class='hs-varid'>dpy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>focusedBorderColor</span> <span class='hs-conid'>Default</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultConfig</span>
<a name="line-98"></a>                 <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>fbc_</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-99"></a>
<a name="line-100"></a>    <span class='hs-varid'>hSetBuffering</span> <span class='hs-varid'>stdout</span> <span class='hs-conid'>NoBuffering</span>
<a name="line-101"></a>
<a name="line-102"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>layout</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>layoutHook</span> <span class='hs-varid'>xmc</span>
<a name="line-103"></a>        <span class='hs-varid'>lreads</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readsLayout</span> <span class='hs-varid'>layout</span>
<a name="line-104"></a>        <span class='hs-varid'>initialWinset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new</span> <span class='hs-varid'>layout</span> <span class='hs-layout'>(</span><span class='hs-varid'>workspaces</span> <span class='hs-varid'>xmc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>SD</span> <span class='hs-varid'>xinesc</span>
<a name="line-105"></a>        <span class='hs-varid'>maybeRead</span> <span class='hs-varid'>reads'</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>reads'</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-106"></a>                                <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>
<a name="line-107"></a>                                <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-108"></a>
<a name="line-109"></a>        <span class='hs-varid'>winset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>initialWinset</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-110"></a>                    <span class='hs-layout'>(</span><span class='hs-str'>"--resume"</span> <span class='hs-conop'>:</span> <span class='hs-varid'>s</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varid'>args</span>
<a name="line-111"></a>                    <span class='hs-varid'>ws</span>                   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeRead</span> <span class='hs-varid'>reads</span> <span class='hs-varid'>s</span>
<a name="line-112"></a>                    <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>W</span><span class='hs-varop'>.</span><span class='hs-varid'>ensureTags</span> <span class='hs-varid'>layout</span> <span class='hs-layout'>(</span><span class='hs-varid'>workspaces</span> <span class='hs-varid'>xmc</span><span class='hs-layout'>)</span>
<a name="line-113"></a>                           <span class='hs-varop'>$</span> <span class='hs-conid'>W</span><span class='hs-varop'>.</span><span class='hs-varid'>mapLayout</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>layout</span> <span class='hs-varop'>.</span> <span class='hs-varid'>maybeRead</span> <span class='hs-varid'>lreads</span><span class='hs-layout'>)</span> <span class='hs-varid'>ws</span>
<a name="line-114"></a>        <span class='hs-varid'>extState</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-115"></a>                     <span class='hs-layout'>(</span><span class='hs-str'>"--resume"</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dyns</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>return</span> <span class='hs-varid'>args</span>
<a name="line-116"></a>                     <span class='hs-varid'>vals</span>                        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeRead</span> <span class='hs-varid'>reads</span> <span class='hs-varid'>dyns</span>
<a name="line-117"></a>                     <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>second</span> <span class='hs-conid'>Left</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vals</span>
<a name="line-118"></a>
<a name="line-119"></a>        <span class='hs-varid'>cf</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>XConf</span>
<a name="line-120"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>display</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpy</span>
<a name="line-121"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>config</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xmc</span>
<a name="line-122"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>theRoot</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rootw</span>
<a name="line-123"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>normalBorder</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nbc</span>
<a name="line-124"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>focusedBorder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fbc</span>
<a name="line-125"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>keyActions</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>keys</span> <span class='hs-varid'>xmc</span> <span class='hs-varid'>xmc</span>
<a name="line-126"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>buttonActions</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mouseBindings</span> <span class='hs-varid'>xmc</span> <span class='hs-varid'>xmc</span>
<a name="line-127"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>mouseFocused</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-128"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>mousePosition</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-129"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>currentEvent</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-130"></a>
<a name="line-131"></a>        <span class='hs-varid'>st</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>XState</span>
<a name="line-132"></a>            <span class='hs-layout'>{</span> <span class='hs-varid'>windowset</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initialWinset</span>
<a name="line-133"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>numberlockMask</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-134"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>mapped</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-135"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>waitingUnmap</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-136"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>dragging</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-137"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>extensibleState</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extState</span>
<a name="line-138"></a>            <span class='hs-layout'>}</span>
<a name="line-139"></a>    <span class='hs-varid'>allocaXEvent</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-140"></a>        <span class='hs-varid'>runX</span> <span class='hs-varid'>cf</span> <span class='hs-varid'>st</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-141"></a>
<a name="line-142"></a>            <span class='hs-varid'>setNumlockMask</span>
<a name="line-143"></a>            <span class='hs-varid'>grabKeys</span>
<a name="line-144"></a>            <span class='hs-varid'>grabButtons</span>
<a name="line-145"></a>
<a name="line-146"></a>            <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sync</span> <span class='hs-varid'>dpy</span> <span class='hs-conid'>False</span>
<a name="line-147"></a>
<a name="line-148"></a>            <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>scan</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>rootw</span>
<a name="line-149"></a>
<a name="line-150"></a>            <span class='hs-comment'>-- bootstrap the windowset, Operations.windows will identify all</span>
<a name="line-151"></a>            <span class='hs-comment'>-- the windows in winset as new and set initial properties for</span>
<a name="line-152"></a>            <span class='hs-comment'>-- those windows.  Remove all windows that are no longer top-level</span>
<a name="line-153"></a>            <span class='hs-comment'>-- children of the root, they may have disappeared since</span>
<a name="line-154"></a>            <span class='hs-comment'>-- restarting.</span>
<a name="line-155"></a>            <span class='hs-varid'>windows</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span> <span class='hs-varop'>.</span> <span class='hs-varid'>foldr</span> <span class='hs-conid'>W</span><span class='hs-varop'>.</span><span class='hs-varid'>delete</span> <span class='hs-varid'>winset</span> <span class='hs-varop'>$</span> <span class='hs-conid'>W</span><span class='hs-varop'>.</span><span class='hs-varid'>allWindows</span> <span class='hs-varid'>winset</span> <span class='hs-varop'>\\</span> <span class='hs-varid'>ws</span>
<a name="line-156"></a>
<a name="line-157"></a>            <span class='hs-comment'>-- manage the as-yet-unmanaged windows</span>
<a name="line-158"></a>            <span class='hs-varid'>mapM_</span> <span class='hs-varid'>manage</span> <span class='hs-layout'>(</span><span class='hs-varid'>ws</span> <span class='hs-varop'>\\</span> <span class='hs-conid'>W</span><span class='hs-varop'>.</span><span class='hs-varid'>allWindows</span> <span class='hs-varid'>winset</span><span class='hs-layout'>)</span>
<a name="line-159"></a>
<a name="line-160"></a>            <span class='hs-varid'>userCode</span> <span class='hs-varop'>$</span> <span class='hs-varid'>startupHook</span> <span class='hs-varid'>initxmc</span>
<a name="line-161"></a>
<a name="line-162"></a>            <span class='hs-comment'>-- main loop, for all you HOF/recursion fans out there.</span>
<a name="line-163"></a>            <span class='hs-varid'>forever</span> <span class='hs-varop'>$</span> <span class='hs-varid'>prehandle</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>io</span> <span class='hs-layout'>(</span><span class='hs-varid'>nextEvent</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>getEvent</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-164"></a>
<a name="line-165"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-166"></a>      <span class='hs-keyword'>where</span>
<a name="line-167"></a>        <span class='hs-comment'>-- if the event gives us the position of the pointer, set mousePosition</span>
<a name="line-168"></a>        <span class='hs-varid'>prehandle</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mouse</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>guard</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_event_type</span> <span class='hs-varid'>e</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>
<a name="line-169"></a>                                     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_x_root</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-170"></a>                                            <span class='hs-layout'>,</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_y_root</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-171"></a>                      <span class='hs-keyword'>in</span> <span class='hs-varid'>local</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mousePosition</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mouse</span><span class='hs-layout'>,</span> <span class='hs-varid'>currentEvent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>e</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>handleWithHook</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-172"></a>        <span class='hs-varid'>evs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>keyPress</span><span class='hs-layout'>,</span> <span class='hs-varid'>keyRelease</span><span class='hs-layout'>,</span> <span class='hs-varid'>enterNotify</span><span class='hs-layout'>,</span> <span class='hs-varid'>leaveNotify</span>
<a name="line-173"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>buttonPress</span><span class='hs-layout'>,</span> <span class='hs-varid'>buttonRelease</span><span class='hs-keyglyph'>]</span>
<a name="line-174"></a>
<a name="line-175"></a>
<a name="line-176"></a><a name="handleWithHook"></a><span class='hs-comment'>-- | Runs handleEventHook from the configuration and runs the default handler</span>
<a name="line-177"></a><span class='hs-comment'>-- function if it returned True.</span>
<a name="line-178"></a><span class='hs-definition'>handleWithHook</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Event</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>X</span> <span class='hs-conid'>()</span>
<a name="line-179"></a><span class='hs-definition'>handleWithHook</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-180"></a>  <span class='hs-varid'>evHook</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-layout'>(</span><span class='hs-varid'>handleEventHook</span> <span class='hs-varop'>.</span> <span class='hs-varid'>config</span><span class='hs-layout'>)</span>
<a name="line-181"></a>  <span class='hs-varid'>whenX</span> <span class='hs-layout'>(</span><span class='hs-varid'>userCodeDef</span> <span class='hs-conid'>True</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getAll</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>evHook</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>handle</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-182"></a>
<a name="line-183"></a><a name="handle"></a><span class='hs-comment'>-- ---------------------------------------------------------------------</span>
<a name="line-184"></a><span class='hs-comment'>-- | Event handler. Map X events onto calls into Operations.hs, which</span>
<a name="line-185"></a><span class='hs-comment'>-- modify our internal model of the window manager state.</span>
<a name="line-186"></a><span class='hs-comment'>--</span>
<a name="line-187"></a><span class='hs-comment'>-- Events dwm handles that we don't:</span>
<a name="line-188"></a><span class='hs-comment'>--</span>
<a name="line-189"></a><span class='hs-comment'>--    [ButtonPress]    = buttonpress,</span>
<a name="line-190"></a><span class='hs-comment'>--    [Expose]         = expose,</span>
<a name="line-191"></a><span class='hs-comment'>--    [PropertyNotify] = propertynotify,</span>
<a name="line-192"></a><span class='hs-comment'>--</span>
<a name="line-193"></a><span class='hs-definition'>handle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Event</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>X</span> <span class='hs-conid'>()</span>
<a name="line-194"></a>
<a name="line-195"></a><span class='hs-comment'>-- run window manager command</span>
<a name="line-196"></a><span class='hs-definition'>handle</span> <span class='hs-layout'>(</span><span class='hs-conid'>KeyEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_event_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_state</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_keycode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>code</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-197"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-varid'>keyPress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withDisplay</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dpy</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-198"></a>        <span class='hs-varid'>s</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>keycodeToKeysym</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>code</span> <span class='hs-num'>0</span>
<a name="line-199"></a>        <span class='hs-varid'>mClean</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cleanMask</span> <span class='hs-varid'>m</span>
<a name="line-200"></a>        <span class='hs-varid'>ks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>keyActions</span>
<a name="line-201"></a>        <span class='hs-varid'>userCodeDef</span> <span class='hs-conid'>()</span> <span class='hs-varop'>$</span> <span class='hs-varid'>whenJust</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>mClean</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span>
<a name="line-202"></a>
<a name="line-203"></a><span class='hs-comment'>-- manage a new window</span>
<a name="line-204"></a><span class='hs-definition'>handle</span> <span class='hs-layout'>(</span><span class='hs-conid'>MapRequestEvent</span>    <span class='hs-layout'>{</span><span class='hs-varid'>ev_window</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withDisplay</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dpy</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-205"></a>    <span class='hs-varid'>wa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getWindowAttributes</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>w</span> <span class='hs-comment'>-- ignore override windows</span>
<a name="line-206"></a>    <span class='hs-comment'>-- need to ignore mapping requests by managed windows not on the current workspace</span>
<a name="line-207"></a>    <span class='hs-varid'>managed</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isClient</span> <span class='hs-varid'>w</span>
<a name="line-208"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>wa_override_redirect</span> <span class='hs-varid'>wa</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>managed</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>manage</span> <span class='hs-varid'>w</span>
<a name="line-209"></a>
<a name="line-210"></a><span class='hs-comment'>-- window destroyed, unmanage it</span>
<a name="line-211"></a><span class='hs-comment'>-- window gone,      unmanage it</span>
<a name="line-212"></a><span class='hs-definition'>handle</span> <span class='hs-layout'>(</span><span class='hs-conid'>DestroyWindowEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_window</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenX</span> <span class='hs-layout'>(</span><span class='hs-varid'>isClient</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-213"></a>    <span class='hs-varid'>unmanage</span> <span class='hs-varid'>w</span>
<a name="line-214"></a>    <span class='hs-varid'>modify</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mapped</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>delete</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapped</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-215"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>waitingUnmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>delete</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>waitingUnmap</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-216"></a>
<a name="line-217"></a><span class='hs-comment'>-- We track expected unmap events in waitingUnmap.  We ignore this event unless</span>
<a name="line-218"></a><span class='hs-comment'>-- it is synthetic or we are not expecting an unmap notification from a window.</span>
<a name="line-219"></a><span class='hs-definition'>handle</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnmapEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_window</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_send_event</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>synthetic</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenX</span> <span class='hs-layout'>(</span><span class='hs-varid'>isClient</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-220"></a>    <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gets</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybe</span> <span class='hs-num'>0</span> <span class='hs-varop'>.</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>w</span> <span class='hs-varop'>.</span> <span class='hs-varid'>waitingUnmap</span><span class='hs-layout'>)</span>
<a name="line-221"></a>    <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>synthetic</span> <span class='hs-varop'>||</span> <span class='hs-varid'>e</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-222"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>unmanage</span> <span class='hs-varid'>w</span>
<a name="line-223"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>modify</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-layout'>{</span> <span class='hs-varid'>waitingUnmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>update</span> <span class='hs-varid'>mpred</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>waitingUnmap</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-224"></a> <span class='hs-keyword'>where</span> <span class='hs-varid'>mpred</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-225"></a>       <span class='hs-varid'>mpred</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>n</span>
<a name="line-226"></a>
<a name="line-227"></a><span class='hs-comment'>-- set keyboard mapping</span>
<a name="line-228"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MappingNotifyEvent</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-229"></a>    <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>refreshKeyboardMapping</span> <span class='hs-varid'>e</span>
<a name="line-230"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_request</span> <span class='hs-varid'>e</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mappingKeyboard</span><span class='hs-layout'>,</span> <span class='hs-varid'>mappingModifier</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-231"></a>        <span class='hs-varid'>setNumlockMask</span>
<a name="line-232"></a>        <span class='hs-varid'>grabKeys</span>
<a name="line-233"></a>
<a name="line-234"></a><span class='hs-comment'>-- handle button release, which may finish dragging.</span>
<a name="line-235"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ButtonEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_event_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-236"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-varid'>buttonRelease</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-237"></a>    <span class='hs-varid'>drag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>dragging</span>
<a name="line-238"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>drag</span> <span class='hs-keyword'>of</span>
<a name="line-239"></a>        <span class='hs-comment'>-- we're done dragging and have released the mouse:</span>
<a name="line-240"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>modify</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dragging</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>f</span>
<a name="line-241"></a>        <span class='hs-conid'>Nothing</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>broadcastMessage</span> <span class='hs-varid'>e</span>
<a name="line-242"></a>
<a name="line-243"></a><span class='hs-comment'>-- handle motionNotify event, which may mean we are dragging.</span>
<a name="line-244"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>MotionEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_event_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-sel'>_t</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>y</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-245"></a>    <span class='hs-varid'>drag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>dragging</span>
<a name="line-246"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>drag</span> <span class='hs-keyword'>of</span>
<a name="line-247"></a>        <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- we're dragging</span>
<a name="line-248"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>broadcastMessage</span> <span class='hs-varid'>e</span>
<a name="line-249"></a>
<a name="line-250"></a><span class='hs-comment'>-- click on an unfocused window, makes it focused on this workspace</span>
<a name="line-251"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ButtonEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_window</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span><span class='hs-varid'>ev_event_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span><span class='hs-varid'>ev_button</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-252"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-varid'>buttonPress</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-253"></a>    <span class='hs-comment'>-- If it's the root window, then it's something we</span>
<a name="line-254"></a>    <span class='hs-comment'>-- grabbed in grabButtons. Otherwise, it's click-to-focus.</span>
<a name="line-255"></a>    <span class='hs-varid'>dpy</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>display</span>
<a name="line-256"></a>    <span class='hs-varid'>isr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isRoot</span> <span class='hs-varid'>w</span>
<a name="line-257"></a>    <span class='hs-varid'>m</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cleanMask</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ev_state</span> <span class='hs-varid'>e</span>
<a name="line-258"></a>    <span class='hs-varid'>mact</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>buttonActions</span><span class='hs-layout'>)</span>
<a name="line-259"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>mact</span> <span class='hs-keyword'>of</span>
<a name="line-260"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>act</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ev_subwindow</span> <span class='hs-varid'>e</span>
<a name="line-261"></a>        <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-262"></a>            <span class='hs-varid'>focus</span> <span class='hs-varid'>w</span>
<a name="line-263"></a>            <span class='hs-varid'>ctf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-layout'>(</span><span class='hs-varid'>clickJustFocuses</span> <span class='hs-varop'>.</span> <span class='hs-varid'>config</span><span class='hs-layout'>)</span>
<a name="line-264"></a>            <span class='hs-varid'>unless</span> <span class='hs-varid'>ctf</span> <span class='hs-varop'>$</span> <span class='hs-varid'>io</span> <span class='hs-layout'>(</span><span class='hs-varid'>allowEvents</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>replayPointer</span> <span class='hs-varid'>currentTime</span><span class='hs-layout'>)</span>
<a name="line-265"></a>    <span class='hs-varid'>broadcastMessage</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- Always send button events.</span>
<a name="line-266"></a>
<a name="line-267"></a><span class='hs-comment'>-- entered a normal window: focus it if focusFollowsMouse is set to</span>
<a name="line-268"></a><span class='hs-comment'>-- True in the user's config.</span>
<a name="line-269"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CrossingEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_window</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_event_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-270"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-varid'>enterNotify</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ev_mode</span>   <span class='hs-varid'>e</span> <span class='hs-varop'>==</span> <span class='hs-varid'>notifyNormal</span>
<a name="line-271"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenX</span> <span class='hs-layout'>(</span><span class='hs-varid'>asks</span> <span class='hs-varop'>$</span> <span class='hs-varid'>focusFollowsMouse</span> <span class='hs-varop'>.</span> <span class='hs-varid'>config</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>focus</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-272"></a>
<a name="line-273"></a><span class='hs-comment'>-- left a window, check if we need to focus root</span>
<a name="line-274"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CrossingEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_event_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-275"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-varid'>leaveNotify</span>
<a name="line-276"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>rootw</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>theRoot</span>
<a name="line-277"></a>         <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_window</span> <span class='hs-varid'>e</span> <span class='hs-varop'>==</span> <span class='hs-varid'>rootw</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_same_screen</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>setFocusX</span> <span class='hs-varid'>rootw</span>
<a name="line-278"></a>
<a name="line-279"></a><span class='hs-comment'>-- configure a window</span>
<a name="line-280"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ConfigureRequestEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_window</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withDisplay</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dpy</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-281"></a>    <span class='hs-varid'>ws</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>windowset</span>
<a name="line-282"></a>    <span class='hs-varid'>wa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getWindowAttributes</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>w</span>
<a name="line-283"></a>
<a name="line-284"></a>    <span class='hs-varid'>bw</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-layout'>(</span><span class='hs-varid'>borderWidth</span> <span class='hs-varop'>.</span> <span class='hs-varid'>config</span><span class='hs-layout'>)</span>
<a name="line-285"></a>
<a name="line-286"></a>    <span class='hs-keyword'>if</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>floating</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span>
<a name="line-287"></a>        <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>member</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span>
<a name="line-288"></a>        <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>configureWindow</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_value_mask</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>WindowChanges</span>
<a name="line-289"></a>                    <span class='hs-layout'>{</span> <span class='hs-varid'>wc_x</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_x</span> <span class='hs-varid'>e</span>
<a name="line-290"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wc_y</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_y</span> <span class='hs-varid'>e</span>
<a name="line-291"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wc_width</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_width</span> <span class='hs-varid'>e</span>
<a name="line-292"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wc_height</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_height</span> <span class='hs-varid'>e</span>
<a name="line-293"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wc_border_width</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>bw</span>
<a name="line-294"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wc_sibling</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_above</span> <span class='hs-varid'>e</span>
<a name="line-295"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wc_stack_mode</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_detail</span> <span class='hs-varid'>e</span> <span class='hs-layout'>}</span>
<a name="line-296"></a>                <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>member</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>float</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-297"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>allocaXEvent</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-298"></a>                 <span class='hs-varid'>setEventType</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>configureNotify</span>
<a name="line-299"></a>                 <span class='hs-varid'>setConfigureEvent</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>w</span> <span class='hs-varid'>w</span>
<a name="line-300"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>wa_x</span> <span class='hs-varid'>wa</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>wa_y</span> <span class='hs-varid'>wa</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>wa_width</span> <span class='hs-varid'>wa</span><span class='hs-layout'>)</span>
<a name="line-301"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>wa_height</span> <span class='hs-varid'>wa</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_border_width</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>none</span> <span class='hs-layout'>(</span><span class='hs-varid'>wa_override_redirect</span> <span class='hs-varid'>wa</span><span class='hs-layout'>)</span>
<a name="line-302"></a>                 <span class='hs-varid'>sendEvent</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>w</span> <span class='hs-conid'>False</span> <span class='hs-num'>0</span> <span class='hs-varid'>ev</span>
<a name="line-303"></a>    <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sync</span> <span class='hs-varid'>dpy</span> <span class='hs-conid'>False</span>
<a name="line-304"></a>
<a name="line-305"></a><span class='hs-comment'>-- configuration changes in the root may mean display settings have changed</span>
<a name="line-306"></a><span class='hs-definition'>handle</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConfigureEvent</span> <span class='hs-layout'>{</span><span class='hs-varid'>ev_window</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenX</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRoot</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varid'>rescreen</span>
<a name="line-307"></a>
<a name="line-308"></a><span class='hs-comment'>-- property notify</span>
<a name="line-309"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>event</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PropertyEvent</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_event_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_atom</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-310"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t</span> <span class='hs-varop'>==</span> <span class='hs-varid'>propertyNotify</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>wM_NAME</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>asks</span> <span class='hs-layout'>(</span><span class='hs-varid'>logHook</span> <span class='hs-varop'>.</span> <span class='hs-varid'>config</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>userCodeDef</span> <span class='hs-conid'>()</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-311"></a>                                         <span class='hs-varid'>broadcastMessage</span> <span class='hs-varid'>event</span>
<a name="line-312"></a>
<a name="line-313"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>e</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ClientMessageEvent</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_message_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mt</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-314"></a>    <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getAtom</span> <span class='hs-str'>"XMONAD_RESTART"</span>
<a name="line-315"></a>    <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>mt</span> <span class='hs-varop'>==</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-316"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>restart</span> <span class='hs-str'>"xmonad"</span> <span class='hs-conid'>True</span>
<a name="line-317"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>broadcastMessage</span> <span class='hs-varid'>e</span>
<a name="line-318"></a>
<a name="line-319"></a><span class='hs-definition'>handle</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>broadcastMessage</span> <span class='hs-varid'>e</span> <span class='hs-comment'>-- trace (eventName e) -- ignoring</span>
<a name="line-320"></a>
<a name="line-321"></a>
<a name="line-322"></a><span class='hs-comment'>-- ---------------------------------------------------------------------</span>
<a name="line-323"></a><span class='hs-comment'>-- IO stuff. Doesn't require any X state</span>
<a name="line-324"></a><span class='hs-comment'>-- Most of these things run only on startup (bar grabkeys)</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="scan"></a><span class='hs-comment'>-- | scan for any new windows to manage. If they're already managed,</span>
<a name="line-327"></a><span class='hs-comment'>-- this should be idempotent.</span>
<a name="line-328"></a><span class='hs-definition'>scan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Display</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Window</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Window</span><span class='hs-keyglyph'>]</span>
<a name="line-329"></a><span class='hs-definition'>scan</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>rootw</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-330"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>queryTree</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>rootw</span>
<a name="line-331"></a>    <span class='hs-varid'>filterM</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>ws</span>
<a name="line-332"></a>  <span class='hs-comment'>-- TODO: scan for windows that are either 'IsViewable' or where WM_STATE ==</span>
<a name="line-333"></a>  <span class='hs-comment'>-- Iconic</span>
<a name="line-334"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>ok</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>wa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWindowAttributes</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>w</span>
<a name="line-335"></a>                  <span class='hs-varid'>a</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>internAtom</span> <span class='hs-varid'>dpy</span> <span class='hs-str'>"WM_STATE"</span> <span class='hs-conid'>False</span>
<a name="line-336"></a>                  <span class='hs-varid'>p</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWindowProperty32</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>a</span> <span class='hs-varid'>w</span>
<a name="line-337"></a>                  <span class='hs-keyword'>let</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>of</span>
<a name="line-338"></a>                            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-num'>3</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> <span class='hs-comment'>-- 3 for iconified</span>
<a name="line-339"></a>                            <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-340"></a>                  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>wa_override_redirect</span> <span class='hs-varid'>wa</span><span class='hs-layout'>)</span>
<a name="line-341"></a>                         <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wa_map_state</span> <span class='hs-varid'>wa</span> <span class='hs-varop'>==</span> <span class='hs-varid'>waIsViewable</span> <span class='hs-varop'>||</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span>
<a name="line-342"></a>
<a name="line-343"></a><a name="setNumlockMask"></a><span class='hs-definition'>setNumlockMask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>X</span> <span class='hs-conid'>()</span>
<a name="line-344"></a><span class='hs-definition'>setNumlockMask</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-345"></a>    <span class='hs-varid'>dpy</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>display</span>
<a name="line-346"></a>    <span class='hs-varid'>ms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getModifierMapping</span> <span class='hs-varid'>dpy</span>
<a name="line-347"></a>    <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>do</span>
<a name="line-348"></a>                        <span class='hs-varid'>ks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>keycodeToKeysym</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>kc</span> <span class='hs-num'>0</span>
<a name="line-349"></a>                        <span class='hs-keyword'>if</span> <span class='hs-varid'>ks</span> <span class='hs-varop'>==</span> <span class='hs-varid'>xK_Num_Lock</span>
<a name="line-350"></a>                            <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>setBit</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-351"></a>                            <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KeyMask</span><span class='hs-layout'>)</span>
<a name="line-352"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>kc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>kc</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span><span class='hs-keyglyph'>]</span>
<a name="line-353"></a>    <span class='hs-varid'>modify</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-layout'>{</span> <span class='hs-varid'>numberlockMask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varop'>.|.</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-varid'>xs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-354"></a>
<a name="line-355"></a><a name="grabKeys"></a><span class='hs-comment'>-- | Grab the keys back</span>
<a name="line-356"></a><span class='hs-definition'>grabKeys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>X</span> <span class='hs-conid'>()</span>
<a name="line-357"></a><span class='hs-definition'>grabKeys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-358"></a>    <span class='hs-conid'>XConf</span> <span class='hs-layout'>{</span> <span class='hs-varid'>display</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpy</span><span class='hs-layout'>,</span> <span class='hs-varid'>theRoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rootw</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ask</span>
<a name="line-359"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>grab</span> <span class='hs-varid'>kc</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>grabKey</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>kc</span> <span class='hs-varid'>m</span> <span class='hs-varid'>rootw</span> <span class='hs-conid'>True</span> <span class='hs-varid'>grabModeAsync</span> <span class='hs-varid'>grabModeAsync</span>
<a name="line-360"></a>    <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ungrabKey</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>anyKey</span> <span class='hs-varid'>anyModifier</span> <span class='hs-varid'>rootw</span>
<a name="line-361"></a>    <span class='hs-varid'>ks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>keyActions</span>
<a name="line-362"></a>    <span class='hs-varid'>forM_</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>keys</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>mask</span><span class='hs-layout'>,</span><span class='hs-varid'>sym</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-363"></a>         <span class='hs-varid'>kc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>keysymToKeycode</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>sym</span>
<a name="line-364"></a>         <span class='hs-comment'>-- "If the specified KeySym is not defined for any KeyCode,</span>
<a name="line-365"></a>         <span class='hs-comment'>-- XKeysymToKeycode() returns zero."</span>
<a name="line-366"></a>         <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>kc</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>grab</span> <span class='hs-varid'>kc</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>mask</span> <span class='hs-varop'>.|.</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>extraModifiers</span>
<a name="line-367"></a>
<a name="line-368"></a><a name="grabButtons"></a><span class='hs-comment'>-- | XXX comment me</span>
<a name="line-369"></a><span class='hs-definition'>grabButtons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>X</span> <span class='hs-conid'>()</span>
<a name="line-370"></a><span class='hs-definition'>grabButtons</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-371"></a>    <span class='hs-conid'>XConf</span> <span class='hs-layout'>{</span> <span class='hs-varid'>display</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpy</span><span class='hs-layout'>,</span> <span class='hs-varid'>theRoot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rootw</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ask</span>
<a name="line-372"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>grab</span> <span class='hs-varid'>button</span> <span class='hs-varid'>mask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>grabButton</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>button</span> <span class='hs-varid'>mask</span> <span class='hs-varid'>rootw</span> <span class='hs-conid'>False</span> <span class='hs-varid'>buttonPressMask</span>
<a name="line-373"></a>                                           <span class='hs-varid'>grabModeAsync</span> <span class='hs-varid'>grabModeSync</span> <span class='hs-varid'>none</span> <span class='hs-varid'>none</span>
<a name="line-374"></a>    <span class='hs-varid'>io</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ungrabButton</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>anyButton</span> <span class='hs-varid'>anyModifier</span> <span class='hs-varid'>rootw</span>
<a name="line-375"></a>    <span class='hs-varid'>ems</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extraModifiers</span>
<a name="line-376"></a>    <span class='hs-varid'>ba</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>buttonActions</span>
<a name="line-377"></a>    <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>grab</span> <span class='hs-varid'>b</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span> <span class='hs-varop'>.|.</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ems</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>keys</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ba</span><span class='hs-layout'>)</span>
<a name="line-378"></a>
<a name="line-379"></a><a name="replace"></a><span class='hs-comment'>-- | @replace@ to signals compliant window managers to exit.</span>
<a name="line-380"></a><span class='hs-definition'>replace</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Display</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ScreenNumber</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Window</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-381"></a><span class='hs-definition'>replace</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>dflt</span> <span class='hs-varid'>rootw</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-382"></a>    <span class='hs-comment'>-- check for other WM</span>
<a name="line-383"></a>    <span class='hs-varid'>wmSnAtom</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>internAtom</span> <span class='hs-varid'>dpy</span> <span class='hs-layout'>(</span><span class='hs-str'>"WM_S"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>dflt</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span>
<a name="line-384"></a>    <span class='hs-varid'>currentWmSnOwner</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xGetSelectionOwner</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>wmSnAtom</span>
<a name="line-385"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>currentWmSnOwner</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-386"></a>        <span class='hs-comment'>-- prepare to receive destroyNotify for old WM</span>
<a name="line-387"></a>        <span class='hs-varid'>selectInput</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>currentWmSnOwner</span> <span class='hs-varid'>structureNotifyMask</span>
<a name="line-388"></a>
<a name="line-389"></a>        <span class='hs-comment'>-- create off-screen window</span>
<a name="line-390"></a>        <span class='hs-varid'>netWmSnOwner</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allocaSetWindowAttributes</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>attributes</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-391"></a>            <span class='hs-varid'>set_override_redirect</span> <span class='hs-varid'>attributes</span> <span class='hs-conid'>True</span>
<a name="line-392"></a>            <span class='hs-varid'>set_event_mask</span> <span class='hs-varid'>attributes</span> <span class='hs-varid'>propertyChangeMask</span>
<a name="line-393"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>screen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultScreenOfDisplay</span> <span class='hs-varid'>dpy</span>
<a name="line-394"></a>                <span class='hs-varid'>visual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultVisualOfScreen</span> <span class='hs-varid'>screen</span>
<a name="line-395"></a>                <span class='hs-varid'>attrmask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cWOverrideRedirect</span> <span class='hs-varop'>.|.</span> <span class='hs-varid'>cWEventMask</span>
<a name="line-396"></a>            <span class='hs-varid'>createWindow</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>rootw</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>100</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>100</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-varid'>copyFromParent</span> <span class='hs-varid'>copyFromParent</span> <span class='hs-varid'>visual</span> <span class='hs-varid'>attrmask</span> <span class='hs-varid'>attributes</span>
<a name="line-397"></a>
<a name="line-398"></a>        <span class='hs-comment'>-- try to acquire wmSnAtom, this should signal the old WM to terminate</span>
<a name="line-399"></a>        <span class='hs-varid'>xSetSelectionOwner</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>wmSnAtom</span> <span class='hs-varid'>netWmSnOwner</span> <span class='hs-varid'>currentTime</span>
<a name="line-400"></a>
<a name="line-401"></a>        <span class='hs-comment'>-- SKIPPED: check if we acquired the selection</span>
<a name="line-402"></a>        <span class='hs-comment'>-- SKIPPED: send client message indicating that we are now the WM</span>
<a name="line-403"></a>
<a name="line-404"></a>        <span class='hs-comment'>-- wait for old WM to go away</span>
<a name="line-405"></a>        <span class='hs-varid'>fix</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>again</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-406"></a>            <span class='hs-varid'>evt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allocaXEvent</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>event</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-407"></a>                <span class='hs-varid'>windowEvent</span> <span class='hs-varid'>dpy</span> <span class='hs-varid'>currentWmSnOwner</span> <span class='hs-varid'>structureNotifyMask</span> <span class='hs-varid'>event</span>
<a name="line-408"></a>                <span class='hs-varid'>get_EventType</span> <span class='hs-varid'>event</span>
<a name="line-409"></a>
<a name="line-410"></a>            <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>evt</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>destroyNotify</span><span class='hs-layout'>)</span> <span class='hs-varid'>again</span>
</pre></body>
</html>
